@model CatalogoWeb.Models.Pedido

@{
    ViewData["Title"] = "Detalle del Pedido #" + Model.Id;
}

<div class="container mt-5">
    <h2 class="mb-4">Detalle del Pedido #@Model.Id</h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            @TempData["Error"]
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información del Pedido</h5>
                </div>
                <div class="card-body">
                    <p><strong>Fecha:</strong> @Model.Fecha.ToString("dd/MM/yyyy HH:mm")</p>
                    <p><strong>Total:</strong> <span class="h5 text-success">$ @Model.Total.ToString("N2")</span></p>
                    <p><strong>Estado:</strong>
                        @switch (Model.Estado)
                        {
                            case EstadoPedido.Pendiente:
                                <span class="badge bg-warning text-dark">Pendiente</span>
                                break;
                            case EstadoPedido.Pagado:
                                <span class="badge bg-success">Pagado</span>
                                break;
                            case EstadoPedido.PagoRechazado:
                                <span class="badge bg-danger">Pago Rechazado</span>
                                break;
                            case EstadoPedido.EnPreparacion:
                                <span class="badge bg-info">En Preparación</span>
                                break;
                            case EstadoPedido.Enviado:
                                <span class="badge bg-primary">Enviado</span>
                                break;
                            case EstadoPedido.Entregado:
                                <span class="badge bg-secondary">Entregado</span>
                                break;
                            case EstadoPedido.Completado:
                                <span class="badge bg-dark">Completado</span>
                                break;
                            case EstadoPedido.Cancelado:
                                <span class="badge bg-danger">Cancelado</span>
                                break;
                        }
                    </p>
                    
                    @if (!string.IsNullOrEmpty(Model.MetodoPago))
                    {
                        <p><strong>Método de Pago:</strong> @Model.MetodoPago</p>
                    }
                    @if (Model.FechaPago.HasValue)
                    {
                        <p><strong>Fecha de Pago:</strong> @Model.FechaPago.Value.ToString("dd/MM/yyyy HH:mm")</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.NumeroTracking))
                    {
                        <p><strong>Tracking:</strong> @Model.NumeroTracking</p>
                    }
                    @if (Model.FechaEnvio.HasValue)
                    {
                        <p><strong>Fecha de Envío:</strong> @Model.FechaEnvio.Value.ToString("dd/MM/yyyy HH:mm")</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.MensajeErrorPago))
                    {
                        <div class="alert alert-danger mt-2">
                            <strong>Error de pago:</strong> @Model.MensajeErrorPago
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Datos de Envío</h5>
                </div>
                <div class="card-body">
                    <p><strong>Nombre:</strong> @Model.Nombre</p>
                    <p><strong>Dirección:</strong> @Model.Direccion</p>
                    <p><strong>Ciudad:</strong> @Model.Ciudad</p>
                    <p><strong>Código Postal:</strong> @Model.CodigoPostal</p>
                    <p><strong>Teléfono:</strong> @Model.Telefono</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Productos</h5>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detalle in Model.Detalles)
                    {
                        <tr>
                            <td>@detalle.NombreProducto</td>
                            <td>$ @detalle.PrecioUnitario.ToString("N2")</td>
                            <td>@detalle.Cantidad</td>
                            <td class="text-end">$ @detalle.SubTotal.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="table-success">
                        <th colspan="3" class="text-end">Total:</th>
                        <th class="text-end">$ @Model.Total.ToString("N2")</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Acciones</h5>
        </div>
        <div class="card-body">
            @if (Model.Estado == EstadoPedido.Pendiente || Model.Estado == EstadoPedido.PagoRechazado)
            {
                <a asp-action="ReintentarPagoForm" asp-route-id="@Model.Id" class="btn btn-success">
                    Procesar Pago
                </a>
                <form asp-action="Cancelar" method="post" class="d-inline">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger" onclick="return confirm('¿Cancelar el pedido?')">
                        Cancelar Pedido
                    </button>
                </form>
            }

            @if (Model.Estado == EstadoPedido.Pagado)
            {
                <form asp-action="MarcarEnPreparacion" method="post" class="d-inline">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-info">
                        Marcar en Preparación
                    </button>
                </form>
            }

            @if (Model.Estado == EstadoPedido.Pagado || Model.Estado == EstadoPedido.EnPreparacion)
            {
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#enviarModal">
                    Marcar como Enviado
                </button>
            }

            @if (Model.Estado == EstadoPedido.Enviado)
            {
                <form asp-action="MarcarEntregado" method="post" class="d-inline">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-secondary">
                        Marcar como Entregado
                    </button>
                </form>
            }

            @if (Model.Estado == EstadoPedido.Entregado)
            {
                <form asp-action="MarcarCompletado" method="post" class="d-inline">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-dark">
                        Completar Pedido
                    </button>
                </form>
            }

            <a asp-action="Index" class="btn btn-outline-secondary">
                Volver al Listado
            </a>
        </div>
    </div>
</div>

<div class="modal fade" id="enviarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enviar Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Enviar" method="post">
                <div class="modal-body">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">Número de Tracking (opcional)</label>
                        <input type="text" class="form-control" name="numeroTracking" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Envío</button>
                </div>
            </form>
        </div>
    </div>
</div>